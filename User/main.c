#include "stm32f10x.h"
#include "LED.h"
#include "usart.h"
#include "key.h"  // ????key???????
#include "adc_collect.h"
#include "string.h"
// ??????????????????????áÃ???????
void USART2_RxProcess(uint8_t *rx_buf, uint16_t rx_len)
{
    // ???????????????????
    USART2_SendData((uint8_t*)"Received: ", 10);
    USART2_SendData(rx_buf, rx_len);
    USART2_SendData((uint8_t*)"\r\n", 2);
	
    // ??????????áÃ?????????????????????????
    if(rx_buf[0] == 'L' && rx_buf[1] == 'E' && rx_buf[2] == 'D')
    {
        toggle_led();  // ?????LED???????LED
    }
}

 

int main(void)
{
    // ?????????
    init_led();
    USART2_Config();
    key_init();
    NVIC_Configuration();
	  ADC_Config();
    // ????????????????????????while?????
    USART2_RegisterRxCallback(USART2_RxProcess);
		 USART2_SendData("system start",strlen("system start"));
	
		 u16 adc_pb0, adc_pb1;               // PB0(CH8)/PB1(CH9)????
    u16 buf_pb0[50], buf_pb1[50];       // ?????????????
		char send_buf[64];
    while (1)
    {
			 
			 ADC_GetDualChannelValue(&adc_pb0, &adc_pb1);
        float volt_pb0 = (float)adc_pb0 * 3.3f / 4095.0f;
        float volt_pb1 = (float)adc_pb1 * 3.3f / 4095.0f;
      sprintf(send_buf, "???¦Â????PB0=%d(%.2fV)  PB1=%d(%.2fV)\r\n", 
                adc_pb0, volt_pb0, adc_pb1, volt_pb1);
        USART2_SendData(send_buf,strlen(send_buf));
			Delay_ms(300);
			
        // 2. ???????50??????
        ADC_ContinuousDualChannel(buf_pb0, buf_pb1, 50);
			
			
    }
}